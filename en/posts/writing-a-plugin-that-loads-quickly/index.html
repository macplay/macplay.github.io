<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Nikola (getnikola.com)">
<title>Writing a plugin that loads quickly - MacPlay</title>
<link rel="apple-touch-icon" sizes="180x180" href="../../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../../favicon-16x16.png">
<link rel="mask-icon" href="../../../safari-pinned-tab.svg" color="#5bbad5">
<link href="../../../assets/css/semantic.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/jquery.fancybox.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="canonical" href="https://macplay.github.io/en/posts/writing-a-plugin-that-loads-quickly/">
<meta name="author" content="ashfinal">
<link rel="alternate" hreflang="zh_cn" href="../../../posts/writing-a-plugin-that-loads-quickly/">
<link rel="stylesheet" type="text/css" href="../../../assets/css/gitalk.css">
</head>
<body>
        <div class="ui grid">
            <div class="computer only three wide column no-print">
                <div id="left-side">
                </div>
            </div>
            <div class="ten wide computer sixteen wide tablet sixteen wide mobile column">
                        <div class="ui inline cookie nag no-print">
            <span class="title">从现在开始，支持中英双语及博文精选 O(∩_∩)O~~</span>
            <i class="close icon"></i>
        </div>
    <header id="header" class="no-print"><div class="ui grid">
        <div class="computer only tablet only sixteen wide column">
            <div class="ui large secondary stackable menu">
                <a class="header item brand-logo" href="https://macplay.github.io/en/">
                    MacPlay
                </a>
                        <a class="item" href="../../../">Posts</a>
                        <a class="item" href="../../../listings/">Code</a>
                        <a class="item" href="../../../galleries/">Gallery</a>
                        <a class="item" href="../../../categories/">Tags</a>
                        <a class="item" href="../../../archive.html">Archive</a>
                <div class="right menu">
                    <a class="item" href="../../../rss.xml"><i class="rss icon"></i>RSS</a>
                </div>
            </div>
        </div>
        <div class="mobile only sixteen wide column">
            <div class="ui fluid accordion vertical menu">
                <div class="item">
                    <a class="title">MacPlay</a>
                    <div class="content">
                                <a class="item" href="../../../">Posts</a>
                                <a class="item" href="../../../listings/">Code</a>
                                <a class="item" href="../../../galleries/">Gallery</a>
                                <a class="item" href="../../../categories/">Tags</a>
                                <a class="item" href="../../../archive.html">Archive</a>
                        <a class="item" href="../../../rss.xml"><i class="rss icon"></i>RSS</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </header><main id="main"><div id="main-content">
<div class="postpage post-text page-body" itemscope="itemscope" itemtype="http://schema.org/Article">
            <h1 class="post-title" itemprop="headline">
        <a href=".">Writing a plugin that loads quickly</a>
    </h1>

    <div class="ui large horizontal link list post-meta">
        <span class="item">By
            <a href="../../authors/ashfinal/">ashfinal</a>
        </span>
            <span class="item">
                <a href="https://github.com/macplay/macplay.github.io/edit/src/posts/writing-a-plugin-that-loads-quickly.en.rst" target="_blank" title="Edit on GitHub">Edit</a>
            </span>
        <span class="item">
            <time datetime="2019-10-18T14:11:04+08:00">
            2019-10-18 14:11
            </time></span>
            <span class="item">
                    <a href="../../categories/plugin/">plugin</a>
                    <a href="../../categories/vim/">vim</a>
            </span>
    </div>

    
    <div class="post-content" itemprop="article text">
        <div id="post-content">
        <div>
<div class="figure align-center">
<a class="reference external image-reference" href="../../../images/lazy_loading.jpg"><img alt="lazy loading" src="../../../images/lazy_loading.thumbnail.jpg"></a>
</div>
<p>A plugin may grow and become quite long. The startup delay may become noticeable, while you hardly ever use the plugin. Then it's time for a quickload plugin.</p>
<!-- TEASER_END -->
<p>The basic idea is that the plugin is loaded twice. The first time user commands and mappings are defined that offer the functionality. The second time the functions that implement the functionality are defined.</p>
<p>It may sound surprising that quickload means loading a script twice. What we mean is that it loads quickly the first time, postponing the bulk of the script to the second time, which only happens when you actually use it. When you always use the functionality it actually gets slower!</p>
<p>Note that since Vim 7 there is an alternative: use the <a class="reference external" href=".">autoload</a> functionality <a class="reference external" href=".">41.15</a> .</p>
<p>The following example shows how it's done:</p>
<pre class="code vim"><a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-1"></a><span class="c">" Vim global plugin for demonstrating quick loading</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-2"></a><span class="c">" Last Change:  2005 Feb 25</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-3"></a><span class="c">" Maintainer:   Bram Moolenaar &lt;Bram@vim.org&gt;</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-4"></a><span class="c">" License:  This file is placed in the public domain.</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-5"></a>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-6"></a><span class="k">if</span> <span class="p">!</span>exists<span class="p">(</span><span class="s2">"s:did_load"</span><span class="p">)</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-7"></a>    command <span class="p">-</span>nargs<span class="p">=</span>* BNRead  <span class="k">call</span> BufNetRead<span class="p">(&lt;</span><span class="k">f</span><span class="p">-</span>args<span class="p">&gt;)</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-8"></a>    map <span class="p">&lt;</span>F19<span class="p">&gt;</span> :<span class="k">call</span> BufNetWrite<span class="p">(</span><span class="s1">'something'</span><span class="p">)&lt;</span>CR<span class="p">&gt;</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-9"></a>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-10"></a>    <span class="k">let</span> s:did_load <span class="p">=</span> <span class="m">1</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-11"></a>    exe <span class="s1">'au FuncUndefined BufNet* source '</span> . expand<span class="p">(</span><span class="s1">'&lt;sfile&gt;'</span><span class="p">)</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-12"></a>    <span class="k">finish</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-13"></a><span class="k">endif</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-14"></a>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-15"></a><span class="k">function</span> BufNetRead<span class="p">(</span>...<span class="p">)</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-16"></a>    echo <span class="s1">'BufNetRead('</span> . string<span class="p">(</span><span class="k">a</span>:<span class="m">000</span><span class="p">)</span> . <span class="s1">')'</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-17"></a><span class="c">    " read functionality here</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-18"></a><span class="k">endfunction</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-19"></a>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-20"></a><span class="k">function</span> BufNetWrite<span class="p">(</span>...<span class="p">)</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-21"></a>    echo <span class="s1">'BufNetWrite('</span> . string<span class="p">(</span><span class="k">a</span>:<span class="m">000</span><span class="p">)</span> . <span class="s1">')'</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-22"></a><span class="c">    " write functionality here</span>
<a name="rest_code_18eee743c8f84c34a0fca3785a0dc902-23"></a><span class="k">endfunction</span>
</pre>
<p>When the script is first loaded "s:did_load" is not set. The commands between the "if" and "endif" will be executed. This ends in a <a class="reference external" href=".">:finish</a> command, thus the rest of the script is not executed.</p>
<p>The second time the script is loaded "s:did_load" exists and the commands after the "endif" are executed. This defines the (possible long) BufNetRead() and BufNetWrite() functions.</p>
<p>If you drop this script in your plugin directory Vim will execute it on startup. This is the sequence of events that happens:</p>
<ol class="arabic simple">
<li><p>The "BNRead" command is defined and the &lt;F19&gt; key is mapped when the script is sourced at startup. A <a class="reference external" href=".">FuncUndefined</a> autocommand is defined. The ":finish" command causes the script to terminate early.</p></li>
<li><p>The user types the BNRead command or presses the &lt;F19&gt; key. The BufNetRead() or BufNetWrite() function will be called.</p></li>
<li><p>Vim can't find the function and triggers the <a class="reference external" href=".">FuncUndefined</a> autocommand event. Since the pattern "BufNet*" matches the invoked function, the command "source fname" will be executed. "fname" will be equal to the name of the script, no matter where it is located, because it comes from expanding "&lt;sfile&gt;" (see <a class="reference external" href=".">expand()</a>).</p></li>
<li><p>The script is sourced again, the "s:did_load" variable exists and the functions are defined.</p></li>
</ol>
<p>Notice that the functions that are loaded afterwards match the pattern in the <a class="reference external" href=".">FuncUndefined</a> autocommand. You must make sure that no other plugin defines functions that match this pattern.</p>
<p><cite>:help usr_41.txt</cite></p>
</div>
        </div>
    </div>
    <div class="post-info">
        <p>文章链接：<a href="https://macplay.github.io/en/posts/writing-a-plugin-that-loads-quickly/" target="_blank">https://macplay.github.io/en/posts/writing-a-plugin-that-loads-quickly/</a></p>
        <p>发布/更新于：
            <time datetime="2019-10-18 14:11:04 UTC+08:00">
            2019-10-18 14:11
            </time></p>
        <p>版权声明：如无特别说明，本站文章均遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 协议，转载请注明作者及出处。</p>
    </div>
        <div class="post-navigation no-print">
        <div class="ui huge secondary stackable menu">
            <a class="post-nav-item post-nav-previous item" href="../vim-cheatsheet-2/" title="Previous post"><i class="angle double left icon"></i> Vim Cheatsheet</a>
        <div class="right menu">
            <a class="post-nav-item post-nav-next item" href="../improve-and-extend-your-text-objects-with-targetsvim/" title="Next post">Improve and Extend Your Text Objects With targets.vim <i class="angle double right icon"></i></a>
        </div>
        </div>
    </div>

        <div id="gitalk-container" class="comments-block no-print"></div>
</div>
                    </div>
                </main><div class="footer extra-block no-print">
    <span class="footer_item">
        <a href="../../../pages/you-qing-lian-jie/">友情链接</a>
    </span>
    <span class="footer_item">
        <a href="../../../pages/liu-yan-ban/">留言板</a>
    </span>
    <span class="footer_item">
        <a href="../../../pages/ge-ren-dong-tai/">碎碎念</a>
    </span>
    </div>
            <div class="footer social-link no-print">
            <a href="https://github.com/ashfinal" target="_blank"><i class="grey large github icon"></i></a>
            <a href="http://weibo.com/ashfinal/" target="_blank"><i class="grey large weibo icon"></i></a>
            <a href="mailto://ashfinal@sina.cn" target="_blank"><i class="grey large mail icon"></i></a>
            </div>
        <div class="ui basic center aligned segment no-print">Contents © 2020         <a href="mailto:ashfinal@sina.cn">ashfinal</a> - Powered by         <a href="https://getnikola.com" target="_blank" rel="nofollow">Nikola</a>         </div>

            </div>
            <div class="computer only three wide column no-print">
                <div id="right-side">
                </div>
            </div>
        </div>

        <!-- GoStats JavaScript Based Code -->
        <script type="text/javascript">(function(c,o,m,p,u,t,e){
        c['GoStatsObject']=u;c[u]=c[u]||function(){(c[u].q=c[u].q||[]).push(arguments)},
        c[u].l=1*new Date();t=o.createElement(m);t.async=1;t.src=p;
        e=o.getElementsByTagName(m)[0];e.parentNode.insertBefore(t,e);
        })(window,document,'script','//www.gostats.org/5.js','go');
        go('init',100479892,{'img_counter_type':5,'img_image_type':1});go('send');</script><!-- End GoStats JavaScript Based Code --><script type="text/javascript" src="../../../assets/js/jquery-3.3.1.min.js"></script><script type="text/javascript" src="../../../assets/js/semantic.min.js"></script><script type="text/javascript" src="../../../assets/js/jquery.fancybox.min.js"></script><script type="text/javascript" src="../../../assets/js/cookie.min.js"></script><script>
            $(document).ready(function(){
                $(".ui.dropdown").dropdown();
                $('.ui.accordion').accordion();
                var newstr = $('.cookie.nag').text();
                $('.cookie.nag').nag({
                    key: 'globalnotice',
                    value: newstr
                  });
                $('.image-reference').fancybox();
            });
        </script><script src="../../../assets/js/md5.min.js"></script><script src="../../../assets/js/gitalk.min.js"></script><script>
        const gitalk = new Gitalk({
            clientID: '12fcda845097d895a24c',
            clientSecret: '50ed60cde5f40897205197b4265b474cefbedc49',
            repo: 'macplay.github.io',
            owner: 'macplay',
            admin: ['macplay', 'ashfinal'],
            id: md5(window.location.pathname),
            // facebook-like distraction free mode
            distractionFreeMode: false
        })
        gitalk.render('gitalk-container')
    </script>
</body>
</html>
